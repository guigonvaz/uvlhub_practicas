## .travis.yml

language: python
python:
  # Versión de Python que usas en Actions
  - "3.12" 

# 1. Configuración del Servicio de Base de Datos
# Se requiere el servicio 'mysql'. Travis lo iniciará automáticamente.
services:
  - mysql

# 2. Variables de Entorno
# Las variables necesarias para conectar a la DB y Codacy.
env:
  global:
    # Variables de la BD (Travis usa por defecto 'travis' sin password para conexión local)
    - FLASK_ENV=testing
    - MARIADB_HOSTNAME=127.0.0.1
    - MARIADB_PORT=3306 
    # Las credenciales de la DB de prueba (El usuario predeterminado es 'travis' sin password)
    - MARIADB_TEST_DATABASE=uvlhubdb_test 
    - MARIADB_USER=travis 
    - MARIADB_PASSWORD="" # El password es vacío para el usuario 'travis' por defecto

    # El token de Codacy (¡Debe configurarse como un Secret en la interfaz de Travis!)
    - secure: "CODACY_PROJECT_TOKEN_VALUE" 
      # ATENCIÓN: Debes obtener el valor encriptado desde la interfaz de Travis CI, no copies esto.

# 3. Fases de Pre-instalación
before_install:
  # Crea la base de datos de pruebas usando la conexión predeterminada de Travis (user: root sin password)
  - mysql -e 'CREATE DATABASE IF NOT EXISTS uvlhubdb_test;' 

# 4. Fase de Instalación
install:
  # Instala las dependencias de Python
  - pip install -r requirements.txt
  # Instala las herramientas de Codacy y coverage
  - pip install codacy-coverage coverage pytest

# 5. Fase de Script (Ejecución de Tests)
script:
  # Ejecuta los tests e ignora los de selenium, guardando el coverage en XML
  - coverage run -m pytest app/modules/ --ignore-glob='*selenium*'
  - coverage xml

# 6. Fase Post-Tests (Subida a Codacy)
after_success:
  # Solo si los tests pasan, sube el reporte a Codacy
  - python-codacy-coverage -r coverage.xml

# Opcional: Cachear para acelerar futuros builds
cache:
  pip: true

# 7. Control de Ramas
branches:
  only:
    - main 
